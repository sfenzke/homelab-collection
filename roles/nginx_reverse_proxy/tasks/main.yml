- name: "Deploy and configure nginx reverse proxy"
  become: true
  block:
    - name: "Install nginx"
      ansible.builtin.package:
        name: "nginx"
        state: "present"

    - name: "Configure reverse proxy"
      ansible.builtin.template:
        src: "nginx.conf.j2"
        dest: "/etc/nginx/sites-available/{{ itemi.domain }}"
        owner: "root"
        group: "root"
        mode: "0600"
      loop: nginx-sites

    - name: "Enable configurations"
      ansible.builtin.file:
        src: "/etc/nginx/sites-available/{{ item.domain }}"
        dest: "/etc/nginx/sites-enabled/{{ item.domain }}"
        owner: "root"
        group: "root"
        mode: "0600"
        state: "link"
      loop: nginx-sites
      notify: "Restart nginx"
